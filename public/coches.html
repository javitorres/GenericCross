<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="utf-8">
    <title>Coches Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.8.0/css/bulma.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dc/3.2.1/dc.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.15.0/d3.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter2/1.5.2/crossfilter.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dc/3.2.1/dc.js" charset="utf-8"></script>

    <style>
        .dc-chart g.row text {
            fill: black;
        }

        .dc-chart g.pie-label-group text {
            fill: black;
        }

        .chart {
            position: relative;
        }

        .reset-link {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
<nav class="navbar is-primary" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
        <h2 class="title is-4 navbar-item">Coches Dashboard</h2>
    </div>
</nav>

<div class="section">
    <div class="columns">
        <!-- Marca Pie Chart -->
        <div class="column is-one-quarter">
            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">Distribución de Marcas</p>
                </header>
                <div class="card-content">
                    <div class="chart" id="marca-pie">
                        <a class="reset-link" href="javascript:marcaPieChart.filterAll();dc.redrawAll();" style="display: none;">Reset</a>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modelo Pie Chart -->
        <div class="column is-one-quarter">
            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">Distribución de Modelos</p>
                </header>
                <div class="card-content">
                    <div class="chart" id="modelo-pie">
                        <a class="reset-link" href="javascript:modeloPieChart.filterAll();dc.redrawAll();" style="display: none;">Reset</a>
                    </div>
                </div>
            </div>
        </div>
        <!-- Potencia Bar Chart -->
        <div class="column is-one-quarter">
            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">Distribución de Potencias</p>
                </header>
                <div class="card-content">
                    <div class="chart" id="potencia-bar">
                        <a class="reset-link" href="javascript:potenciaBarChart.filterAll();dc.redrawAll();" style="display: none;">Reset</a>
                    </div>
                </div>
            </div>
        </div>
        <!-- Fecha Line Chart -->
        <div class="column is-one-quarter">
            <div class="card">
                <header class="card-header">
                    <p class="card-header-title">Coches por Fecha</p>
                </header>
                <div class="card-content">
                    <div class="chart" id="fecha-line">
                        <a class="reset-link" href="javascript:fechaLineChart.filterAll();dc.redrawAll();" style="display: none;">Reset</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var marcaPieChart = dc.pieChart('#marca-pie');
    var modeloPieChart = dc.pieChart('#modelo-pie');
    var potenciaBarChart = dc.barChart('#potencia-bar');
    var fechaLineChart = dc.lineChart('#fecha-line');

    d3.csv('data/coches.csv').then((data) => {
        data.forEach(function (d) {
            d.potencia = +d.potencia; // Convertir potencia a número
            d.fecha = new Date(d.fecha); // Convertir fecha a objeto Date
        });

        var ndx = crossfilter(data);
        var marcaDim = ndx.dimension(d => d.marca);
        var modeloDim = ndx.dimension(d => d.modelo);
        var potenciaDim = ndx.dimension(d => d.potencia);
        var fechaDim = ndx.dimension(d => d.fecha);

        var marcaGroup = marcaDim.group();
        var modeloGroup = modeloDim.group();
        var potenciaGroup = potenciaDim.group(Math.floor);
        var fechaGroup = fechaDim.group(d3.timeDay);

        marcaPieChart
            .width(180)
            .height(180)
            .radius(80)
            .dimension(marcaDim)
            .group(marcaGroup)
            .on('filtered', function() {
                d3.select('#marca-pie .reset-link').style('display', this.hasFilter() ? 'block' : 'none');
            });

        modeloPieChart
            .width(180)
            .height(180)
            .radius(80)
            .dimension(modeloDim)
            .group(modeloGroup)
            .on('filtered', function() {
                d3.select('#modelo-pie .reset-link').style('display', this.hasFilter() ? 'block' : 'none');
            });

        potenciaBarChart
            .width(180)
            .height(180)
            .x(d3.scaleLinear().domain([0, 300])) // Ajustar según el rango de potencia
            .xUnits(dc.units.fp.precision(10)) // Ajustar la precisión según sea necesario
            .brushOn(true)
            .dimension(potenciaDim)
            .barPadding(0.1)
            .outerPadding(0.05)
            .group(potenciaGroup)
            .on('filtered', function() {
                d3.select('#potencia-bar .reset-link').style('display', this.hasFilter() ? 'block' : 'none');
            });

        fechaLineChart
            .width(180)
            .height(180)
            .x(d3.scaleTime().domain(d3.extent(data, d => d.fecha))) // Escala de tiempo basada en el rango de fechas
            .round(d3.timeDay.round)
            .xUnits(d3.timeDays)
            .elasticY(true)
            .dimension(fechaDim)
            .group(fechaGroup)
            .on('filtered', function() {
                d3.select('#fecha-line .reset-link').style('display', this.hasFilter() ? 'block' : 'none');
            });

        dc.renderAll();
    });
</script>
</body>
</html>
